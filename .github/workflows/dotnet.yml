name: Timberyard

on:
  push:
    branches: [ main, Development ]
  pull_request:
    branches: [ main, Development ]

jobs:
  linter:
    name:  Linter
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x
    - name: Install formater
      run: dotnet tool install --global dotnet-format
    - name: Run formater
      run: dotnet-format --check --verbosity diagnostic

  build:
    needs: linter
    name:  Build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        dotnet-version: 3.1.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Install formater
      run: dotnet tool install --global dotnet-format
    - name: Build
      run: dotnet build --no-restore

  unittests:      
    needs: build
    name:  Unit Tests
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        dotnet-version: 3.1.x
    - name: Install formater
      run: dotnet tool install --global dotnet-format
    - name: Unit Tests-ETL
      run: dotnet test '.\ETLTests\ETLTests.csproj'
    - name: Unit Tests-Web Service
      run: dotnet test '.\Timberyard-UnitTests\TimberyardTests.csproj' --filter Category=Unit
  
  integrationtests:      
    needs: unittests
    name:  Integration Tests
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        dotnet-version: 3.1.x
    - name: Install formater
      run: dotnet tool install --global dotnet-format
    - name: Initialize MS-SQL Server
      run: docker-compose --file .\testing-DB-docker-image\docker-compose.yaml up -d
    - name: Wait for server to init
      run: start-sleep -s 90
    - name: Integration Tests-Web Service
      run: 
        $env:DatabaseSettings__ConnectionString="Initial Catalog=Timberyard;"
        $env:DatabaseSettings__DbServer="LOCALHOST\\SQLEXPRESS"
        $env:DatabaseSettings__DbPassword="timberyard_service"
        $env:DatabaseSettings__DbUsername="timberyard_service"
        $env:SMPTClientSettings__Host="localhost"
        $env:SMPTClientSettings__Port="25"
        $env:SMPTClientSettings__SenderAddress="Timberyard"
        dotnet test '.\Timberyard-UnitTests\TimberyardTests.csproj' --filter Category=Integration
    - name: Shutdown MS-SQL Server
      run:  docker-compose --file .\testing-DB-docker-image\docker-compose.yaml down